apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: daki-postgres-database
  title: Daki PostgreSQL Database
  description: Cria um database PostgreSQL usando Crossplane
  tags:
    - crossplane
    - postgresql
    - database
    - daki
spec:
  owner: platform-team
  type: resource

  parameters:
    - title: Informa√ß√µes do Database
      required:
        - databaseName
        - claimName
      properties:
        databaseName:
          title: Nome do Database
          type: string
          description: Nome do database PostgreSQL (use snake_case, ex. myapp_production)
          pattern: '^[a-z][a-z0-9_]*$'
          ui:autofocus: true
          ui:help: 'Use snake_case. Ex: myapp_production, app_staging'
        
        claimName:
          title: Nome do Claim
          type: string
          description: Nome do recurso Kubernetes (use kebab-case, ex. myapp-production)
          pattern: '^[a-z][a-z0-9-]*$'
          ui:help: 'Use kebab-case. Ex: myapp-production, app-staging'

    - title: Configura√ß√µes Avan√ßadas
      properties:
        connectionLimit:
          title: Limite de Conex√µes
          type: integer
          description: M√°ximo de conex√µes simult√¢neas (-1 = ilimitado)
          default: -1
          ui:help: 'Use -1 para ilimitado ou um n√∫mero positivo para limitar'
        
        allowConnections:
          title: Permitir Conex√µes
          type: boolean
          description: Permite conex√µes ao database
          default: true
          ui:help: 'Desabilite para manuten√ß√£o'
        
        deletionPolicy:
          title: Pol√≠tica de Dele√ß√£o
          type: string
          description: O que acontece ao deletar o claim
          default: Delete
          enum:
            - Delete
            - Orphan
          enumNames:
            - 'Delete - Remove database do PostgreSQL'
            - 'Orphan - Mant√©m database no PostgreSQL (seguro)'
          ui:help: 'Orphan √© recomendado para produ√ß√£o'
        
        environment:
          title: Ambiente
          type: string
          description: Ambiente do database
          default: development
          enum:
            - development
            - staging
            - production
          enumNames:
            - 'Development'
            - 'Staging'
            - 'Production'
        
        providerConfigRef:
          title: Provider Config
          type: string
          description: Nome do ProviderConfig do Crossplane
          default: poc-postgres-aurora
          ui:help: 'Deixe o padr√£o se n√£o souber'

  steps:
    - id: fetch-base
      name: Preparar template
      action: fetch:template
      input:
        url: ./skeleton
        values:
          databaseName: ${{ parameters.databaseName }}
          claimName: ${{ parameters.claimName }}
          connectionLimit: ${{ parameters.connectionLimit }}
          allowConnections: ${{ parameters.allowConnections }}
          deletionPolicy: ${{ parameters.deletionPolicy }}
          environment: ${{ parameters.environment }}
          providerConfigRef: ${{ parameters.providerConfigRef }}

    - id: log
      name: Log dos arquivos gerados
      action: debug:log
      input:
        message: 'Arquivos gerados para ${{ parameters.claimName }}'

  output:
    links:
      - title: Arquivo YAML gerado
        icon: description
        url: ${{ steps['fetch-base'].output.targetPath }}/database.yaml
    text:
      - title: Pr√≥ximos passos
        content: |
          ## Database PostgreSQL criado com sucesso! üéâ
          
          **Nome do Claim:** `${{ parameters.claimName }}`
          **Nome do Database:** `${{ parameters.databaseName }}`
          **Ambiente:** `${{ parameters.environment }}`
          **Pol√≠tica de Dele√ß√£o:** `${{ parameters.deletionPolicy }}`
          
          ### Como aplicar:
          
          ```bash
          kubectl apply -f database.yaml
          ```
          
          ### Verificar status:
          
          ```bash
          kubectl get dakipostgresdatabases ${{ parameters.claimName }}
          kubectl describe dakipostgresdatabase ${{ parameters.claimName }}
          ```
          
          ### Ver database no PostgreSQL:
          
          ```bash
          kubectl get databases.postgresql.postgresql.upbound.io
          ```
          
          ### Deletar (quando necess√°rio):
          
          ```bash
          kubectl delete dakipostgresdatabase ${{ parameters.claimName }}
          ```
          
          {% if parameters.deletionPolicy == "Orphan" %}
          ‚ö†Ô∏è **Aten√ß√£o:** Voc√™ escolheu `deletionPolicy: Orphan`. O database permanecer√° no PostgreSQL mesmo ap√≥s deletar o claim.
          {% endif %}
          
          {% if parameters.environment == "production" %}
          üîí **Produ√ß√£o:** Recomendamos usar `deletionPolicy: Orphan` e `connectionLimit` apropriado.
          {% endif %}
